<% layout("layouts/admin-layout") %>


    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <a href="/admin/dashboard" class="btn btn-outline-secondary btn-sm mb-2">
                    <i class="bi bi-arrow-left"></i> Back to List
                </a>
                <h2 class="fw-bold text-navy">Application Review</h2>
                <p class="text-muted small">Submitted on: <%= student.submittedAt ? student.submittedAt.toLocaleDateString('en-GB') : 'N/A' %>
                </p>
            </div>
            <div class="btn-group shadow-sm">
                <button class="btn btn-navy" onclick="printFromAdmin()">
                    <i class="bi bi-printer me-2"></i> Print Slip
                </button>
                <button class="btn btn-success" onclick="downloadFromAdmin()">
                    <i class="bi bi-file-earmark-pdf me-2"></i> Download PDF
                </button>
            </div>
        </div>

        

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold text-navy"><i class="bi bi-person-badge me-2"></i>Student Particulars
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Full Name</label>
                                <span class="fw-bold">
                                    <%= student.firstName %>
                                        <%= student.middleName %>
                                            <%= student.lastName %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Aadhaar / APAAR</label>
                                <span>
                                    <%= student.aadhaarNumber || 'N/A' %> / <%= student.apaarId || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Class / DOB</label>
                                <span class="badge bg-light text-navy border">
                                    <%= student.requiredClass %>
                                </span> | <%= student.dob ? student.dob.toLocaleDateString('en-GB') : 'N/A' %>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Stream / Subjects</label>
                                <span class="text-orange fw-bold">
                                    <%= student.stream %>
                                </span><br>
                                <small>
                                    <%= (student.selectedSubjects && student.selectedSubjects.length) ? student.selectedSubjects.join(', ') : 'N/A' %>
                                </small>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Gender / Blood Group</label>
                                <span>
                                    <%= student.gender %> / <%= student.bloodGroup || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Identification Mark</label>
                                <span>
                                    <%= student.identificationMark || 'None' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Religion / Caste</label>
                                <span>
                                    <%= student.religion || 'N/A' %> / <%= student.caste || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Nationality</label>
                                <span>
                                    <%= student.nationality || 'Indian' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Place</label>
                                <span>
                                    <%= student.applicationPlace || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block">Permanent Address</label>
                                <span>
                                    <%= student.permanentAddress || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block">Present Address</label>
                                <span>
                                    <%= student.presentAddress || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Physically Handicapped</label>
                                <span>
                                    <%= student.isHandicapped || 'No' %>
                                </span>
                            </div>
                            <div class="col-md-8">
                                <label class="text-muted small d-block">Handicap Details</label>
                                <span>
                                    <%= student.handicapDetails || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Height / Weight</label>
                                <span>
                                    <%= student.height || 'N/A' %> / <%= student.weight || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Distance From School</label>
                                <span>
                                    <%= student.distanceFromSchool || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small d-block">Local Guardian</label>
                                <span>
                                    <%= student.localGuardianName || 'N/A' %>
                                </span>
                            </div>
                            <div class="col-md-6">
                                <label class="text-muted small d-block">Siblings In School</label>
                                <span>
                                    <%= student.siblingsInSchool || 'N/A' %>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold text-navy"><i class="bi bi-people me-2"></i>Parental Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6 border-end">
                                <h6 class="fw-bold text-muted small text-uppercase mb-3">Father's Info</h6>
                                <p class="mb-1"><strong>Name:</strong>
                                    <%= student.fatherName %>
                                </p>
                                <p class="mb-1"><strong>Occupation:</strong>
                                    <%= student.fatherOccupation || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Income:</strong>
                                    <%= student.fatherIncome || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Education:</strong>
                                    <%= student.fatherEducation || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Aadhaar:</strong>
                                    <%= student.fatherAadhaar || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>WhatsApp:</strong>
                                    <%= student.fatherWhatsApp || 'N/A' %>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold text-muted small text-uppercase mb-3">Mother's Info</h6>
                                <p class="mb-1"><strong>Name:</strong>
                                    <%= student.motherName %>
                                </p>
                                <p class="mb-1"><strong>Occupation:</strong>
                                    <%= student.motherOccupation || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Income:</strong>
                                    <%= student.motherIncome || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Education:</strong>
                                    <%= student.motherEducation || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Aadhaar:</strong>
                                    <%= student.motherAadhaar || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>Contact:</strong>
                                    <%= student.motherContact || 'N/A' %>
                                </p>
                                <p class="mb-1"><strong>WhatsApp:</strong>
                                    <%= student.motherWhatsApp || 'N/A' %>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="mb-0 fw-bold text-navy"><i class="bi bi-file-earmark-check me-2"></i>Transfer &
                            Checklist</h5>
                    </div>
                    <div class="card-body">
                        <p class="fw-bold small text-muted">PREVIOUS SCHOOL:</p>
                        <p>
                            <%= student.previousSchool || 'N/A' %> (DISE: <%= student.previousSchoolDise || 'N/A' %>)
                        </p>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <small class="text-muted fw-bold d-block">PEN</small>
                                <div><%= student.previousSchoolPen || 'N/A' %></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted fw-bold d-block">Previous Class</small>
                                <div><%= student.previousSchoolClass || 'N/A' %></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted fw-bold d-block">Previous Result</small>
                                <div><%= student.previousSchoolResult || 'N/A' %></div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted fw-bold d-block">Previous Attendance</small>
                                <div><%= student.previousSchoolAttendance || 'N/A' %></div>
                            </div>
                            <div class="col-md-12">
                                <small class="text-muted fw-bold d-block">Previous School Address</small>
                                <div><%= student.previousSchoolAddress || 'N/A' %></div>
                            </div>
                        </div>
                        <hr>
                        <p class="fw-bold small text-muted">DOCUMENTS SUBMITTED:</p>
                        <div class="d-flex flex-wrap gap-2">
                            <% (student.documentsSubmitted || []).forEach(doc=> { %>
                                <span class="badge bg-success-subtle text-success border border-success-subtle"><i
                                        class="bi bi-check2"></i>
                                    <%= doc %>
                                </span>
                                <% }) %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm rounded-4 mb-4 text-center p-4">
                    <img src="<%= (student.studentPhoto && student.studentPhoto.url) ? student.studentPhoto.url : '/img/default-avatar.png' %>"
                        class="img-thumbnail rounded-4 mb-3 mx-auto"
                        style="width: 150px; height: 180px; object-fit: cover;">
                    <h5 class="fw-bold mb-1">
                        <%= student.firstName %>
                            <%= student.lastName %>
                    </h5>
                    <p class="text-muted small">Application ID: <%= student._id %>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const applicationId = <%- JSON.stringify(String(student._id)) %>;
        const appNo = `APP-2026-${applicationId.slice(-6).toUpperCase()}`;

        // Build a safe JS object (avoids breaking JS if values contain quotes/backticks).
        const studentData = {
            firstName: <%- JSON.stringify(student.firstName || "") %>,
            middleName: <%- JSON.stringify(student.middleName || "") %>,
            lastName: <%- JSON.stringify(student.lastName || "") %>,
            dob: <%- JSON.stringify(student.dob ? student.dob.toLocaleDateString('en-GB') : "") %>,
            gender: <%- JSON.stringify(student.gender || "") %>,
            requiredClass: <%- JSON.stringify(student.requiredClass || "") %>,
            stream: <%- JSON.stringify(student.stream || "") %>,
            fatherName: <%- JSON.stringify(student.fatherName || "") %>,
            motherName: <%- JSON.stringify(student.motherName || "") %>,
            mobile: <%- JSON.stringify(student.mobile || "") %>,
            permanentAddress: <%- JSON.stringify(student.permanentAddress || "") %>,
            presentAddress: <%- JSON.stringify(student.presentAddress || "") %>,
            aadhaarNumber: <%- JSON.stringify(student.aadhaarNumber || "") %>,
            apaarId: <%- JSON.stringify(student.apaarId || "") %>,
            bloodGroup: <%- JSON.stringify(student.bloodGroup || "") %>,
            identificationMark: <%- JSON.stringify(student.identificationMark || "") %>,
            religion: <%- JSON.stringify(student.religion || "") %>,
            caste: <%- JSON.stringify(student.caste || "") %>,
            nationality: <%- JSON.stringify(student.nationality || "Indian") %>,
            fatherOccupation: <%- JSON.stringify(student.fatherOccupation || "") %>,
            fatherIncome: <%- JSON.stringify(student.fatherIncome || "") %>,
            fatherEducation: <%- JSON.stringify(student.fatherEducation || "") %>,
            fatherAadhaar: <%- JSON.stringify(student.fatherAadhaar || "") %>,
            fatherWhatsApp: <%- JSON.stringify(student.fatherWhatsApp || "") %>,
            motherContact: <%- JSON.stringify(student.motherContact || "") %>,
            motherOccupation: <%- JSON.stringify(student.motherOccupation || "") %>,
            motherIncome: <%- JSON.stringify(student.motherIncome || "") %>,
            motherEducation: <%- JSON.stringify(student.motherEducation || "") %>,
            motherAadhaar: <%- JSON.stringify(student.motherAadhaar || "") %>,
            motherWhatsApp: <%- JSON.stringify(student.motherWhatsApp || "") %>,
            localGuardianName: <%- JSON.stringify(student.localGuardianName || "") %>,
            siblingsInSchool: <%- JSON.stringify(student.siblingsInSchool || "") %>,
            isHandicapped: <%- JSON.stringify(student.isHandicapped || "") %>,
            handicapDetails: <%- JSON.stringify(student.handicapDetails || "") %>,
            height: <%- JSON.stringify(student.height || "") %>,
            weight: <%- JSON.stringify(student.weight || "") %>,
            distanceFromSchool: <%- JSON.stringify(student.distanceFromSchool || "") %>,
            previousSchool: <%- JSON.stringify(student.previousSchool || "") %>,
            previousSchoolDise: <%- JSON.stringify(student.previousSchoolDise || "") %>,
            prevPenNo: <%- JSON.stringify(student.previousSchoolPen || "") %>,
            previousResult: <%- JSON.stringify(student.previousSchoolResult || student.previousResult || "") %>,
            prevAttendance: <%- JSON.stringify(student.previousSchoolAttendance || student.prevAttendance || "") %>,
            prevClass: <%- JSON.stringify(student.previousSchoolClass || student.prevClass || "") %>,
            applicationPlace: <%- JSON.stringify(student.applicationPlace || "") %>,
            selectedSubjects: <%- JSON.stringify(student.selectedSubjects || []) %>,
            documentsSubmitted: <%- JSON.stringify(student.documentsSubmitted || []) %>,
            studentPhotoDataUrl: <%- JSON.stringify((student.studentPhoto && student.studentPhoto.url) ? student.studentPhoto.url : "") %>
        };

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function urlToDataURL(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    } catch (err) {
                        reject(err);
                    }
                };
                img.onerror = reject;
                img.src = url;
            });
        }

        async function ensureJsPdf() {
            if (window.jspdf && window.jspdf.jsPDF) return;
            await new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                s.onload = resolve;
                s.onerror = reject;
                document.body.appendChild(s);
            });
        }

        async function ensureHtml2Canvas() {
            if (window.html2canvas) return;
            await new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                s.onload = resolve;
                s.onerror = reject;
                document.body.appendChild(s);
            });
        }

        function writeReceipt(targetDoc, data, printableAppId) {
            const currentDate = new Date().toLocaleDateString('en-GB');
            const heightVal = (data.height && String(data.height).trim() ? String(data.height).trim() : '__').replace(/\s*cm$/i, '');
            const weightVal = (data.weight && String(data.weight).trim() ? String(data.weight).trim() : '__').replace(/\s*kg$/i, '');
            const distanceVal = (data.distanceFromSchool && String(data.distanceFromSchool).trim() ? String(data.distanceFromSchool).trim() : '__').replace(/\s*km$/i, '');
            const subjectText = (data.selectedSubjects && data.selectedSubjects.length) ? data.selectedSubjects.join(', ') : 'N/A';
            const docsList = Array.isArray(data.documentsSubmitted) ? data.documentsSubmitted : (data.documentsSubmitted ? [data.documentsSubmitted] : []);

            targetDoc.open();
            targetDoc.write(`
        <html>
            <head>
                <title>Admission Form - Blossom World</title>
                <style>
                    @media print { .no-print { display: none; } @page { margin: 1cm; } }
                    body { font-family: 'Times New Roman', Times, serif; padding: 20px; color: #000; line-height: 1.3; font-size: 13px; }
                    .form-border { border: 2px solid #000; padding: 15px; position: relative; }
                    .header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 10px; }
                    .school-name { font-size: 24px; font-weight: bold; margin: 0; }
                    .school-loc { font-size: 14px; margin-top: 5px; }
                    .form-title { font-weight: bold; text-decoration: underline; font-size: 16px; margin-top: 10px; }
                    .photo-box { position: absolute; top: 15px; right: 15px; width: 110px; height: 130px; border: 1px solid #000; text-align: center; font-size: 10px; padding: 5px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
                    .section-head { background: #eee; font-weight: bold; padding: 3px 8px; margin-top: 15px; border: 1px solid #000; font-size: 13px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 5px; }
                    th { text-align: left; width: 35%; padding: 4px; border: 1px solid #ccc; font-weight: bold; background: #fafafa; }
                    td { padding: 4px; border: 1px solid #ccc; }
                    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                    .sig-section { margin-top: 25px; display: flex; justify-content: space-between; text-align: center; }
                    .sig-box { width: 30%; }
                    .sig-line { border-top: 1px solid #000; margin-top: 40px; padding-top: 5px; font-weight: bold; font-size: 11px; }
                    .declaration-box { margin-top: 20px; font-size: 12px; text-align: justify; border: 1px solid #000; padding: 10px; }
                    .office-use { margin-top: 20px; border: 2px solid #000; padding: 10px; background: #fff; }
                    .office-title { font-weight: bold; text-decoration: underline; margin-bottom: 8px; text-align: center; }
                    .checkbox-item { margin-right: 15px; display: inline-block; }
                </style>
            </head>
            <body>
                <div class="form-border">
                    <div class="photo-box">
                        ${data.studentPhotoDataUrl
                    ? `<img src="${escapeHtml(data.studentPhotoDataUrl)}" alt="Student Photo" style="width:100%;height:100%;object-fit:cover;">`
                    : 'Affix recent passport size color photo of the candidate'
                }
                    </div>

                    <div class="header">
                        <img src="/img/logo.jpg" alt="School Logo" style="height:60px; margin-bottom:6px;">
                        <h1 class="school-name">BLOSSOM WORLD SENIOR SECONDARY SCHOOL</h1>
                        <div class="school-loc">Uttarkrishnapur-II, Cachar, Assam</div>
                        <div class="form-title">APPLICATION FORM</div>
                        <p><strong>Application ID:</strong> ${escapeHtml(printableAppId || '________')}</p>
                    </div>

                    <p><strong>To, The Principal,</strong> Sir/Madam, I beg to apply for the admission of my son/daughter/ward <strong>${escapeHtml(((data.firstName || '') + ' ' + (data.middleName || '') + ' ' + (data.lastName || '')).toUpperCase())}</strong> in your school. The particulars are furnished below:</p>

                    <div class="section-head">1. STUDENT PARTICULARS</div>
                    <table>
                        <tr><th>Aadhaar / APAAR ID</th><td>${escapeHtml(data.aadhaarNumber || '________')} / ${escapeHtml(data.apaarId || '________')}</td></tr>
                        <tr><th>Class / DOB</th><td>${escapeHtml(data.requiredClass || '________')} / ${escapeHtml(data.dob || '________')}</td></tr>
                        <tr><th>Stream / Subjects</th><td>${escapeHtml(data.stream || 'None')} / ${escapeHtml(subjectText)}</td></tr>
                        <tr><th>Blood Group / Identification</th><td>${escapeHtml(data.bloodGroup || '________')} / ${escapeHtml(data.identificationMark || '________')}</td></tr>
                        <tr><th>Religion / Caste / Nationality</th><td>${escapeHtml(data.religion || '________')} / ${escapeHtml(data.caste || '________')} / ${escapeHtml(data.nationality || 'Indian')}</td></tr>
                        <tr><th>Permanent / Present Address</th><td>${escapeHtml(data.permanentAddress || '________')} / ${escapeHtml(data.presentAddress || '________')}</td></tr>
                    </table>

                    <div class="grid-2">
                        <div>
                            <div class="section-head">2. FATHER'S PARTICULARS</div>
                            <table>
                                <tr><th>Name</th><td>${escapeHtml(data.fatherName || '________')}</td></tr>
                                <tr><th>Occupation / Income</th><td>${escapeHtml(data.fatherOccupation || '________')} / ${escapeHtml(data.fatherIncome || '________')}</td></tr>
                                <tr><th>Education</th><td>${escapeHtml(data.fatherEducation || '________')}</td></tr>
                                <tr><th>Aadhaar / WhatsApp</th><td>${escapeHtml(data.fatherAadhaar || '________')} / ${escapeHtml(data.fatherWhatsApp || '________')}</td></tr>
                            </table>
                        </div>
                        <div>
                            <div class="section-head">3. MOTHER'S PARTICULARS</div>
                            <table>
                                <tr><th>Name</th><td>${escapeHtml(data.motherName || '________')}</td></tr>
                                <tr><th>Occupation / Income</th><td>${escapeHtml(data.motherOccupation || '________')} / ${escapeHtml(data.motherIncome || '________')}</td></tr>
                                <tr><th>Education</th><td>${escapeHtml(data.motherEducation || '________')}</td></tr>
                                <tr><th>Aadhaar / Contact / WhatsApp</th><td>${escapeHtml(data.motherAadhaar || '________')} / ${escapeHtml(data.motherContact || '________')} / ${escapeHtml(data.motherWhatsApp || '________')}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="section-head">4. ADDITIONAL DETAILS</div>
                    <table>
                        <tr><th>Local Guardian</th><td>${escapeHtml(data.localGuardianName || '________________')}</td></tr>
                        <tr><th>Siblings in School</th><td>${escapeHtml(data.siblingsInSchool || 'None')}</td></tr>
                        <tr><th>Physically Handicapped</th><td>${escapeHtml(data.isHandicapped || 'No')} ${data.handicapDetails ? `(${escapeHtml(data.handicapDetails)})` : ''}</td></tr>
                        <tr><th>Height / Weight / Distance</th><td>${escapeHtml(heightVal)} cm / ${escapeHtml(weightVal)} kg / ${escapeHtml(distanceVal)} km</td></tr>
                    </table>

                    <div class="section-head">5. FOR TRANSFER STUDENTS</div>
                    <table>
                        <tr><th>Prev. School / DISE</th><td>${escapeHtml(data.previousSchool || '________________')} / ${escapeHtml(data.previousSchoolDise || '________')}</td></tr>
                        <tr><th>PEN / APAAR ID</th><td>${escapeHtml(data.prevPenNo || '________')} / ${escapeHtml(data.apaarId || '________')}</td></tr>
                        <tr><th>Prev. Result / Attendance</th><td>${escapeHtml(data.previousResult || '____')}% / ${escapeHtml(data.prevAttendance || '____')} days</td></tr>
                        <tr><th>Prev. Class</th><td>${escapeHtml(data.prevClass || '________')}</td></tr>
                    </table>

                    <div class="section-head">6. DOCUMENTS SUBMITTED</div>
                    <table>
                        <tr><th>Checklist</th><td>${docsList.length ? docsList.map((d) => escapeHtml(d)).join(', ') : 'N/A'}</td></tr>
                    </table>

                    <div class="section-head">18. SPECIMEN SIGNATURES</div>
                    <div class="sig-section">
                        <div class="sig-box"><div class="sig-line">Local Guardian</div></div>
                        <div class="sig-box"><div class="sig-line">Mother</div></div>
                        <div class="sig-box"><div class="sig-line">Father</div></div>
                    </div>

                    <div class="declaration-box">
                        I hereby declare that the information supplied above is true to the best of my knowledge and belief. The rules and regulation of the school shall be strictly adhered to by my son/daughter/ward. Any hindrance of my child's part, he/she shall accept any decision deemed by the school authority.
                        <br><br>
                        <strong>Date:</strong> ${escapeHtml(currentDate)} &nbsp;&nbsp;&nbsp; <strong>Place:</strong> ${escapeHtml(data.applicationPlace || '__________')}
                        <div style="float:right; text-align:center; width:200px; border-top:1px solid #000; margin-top:20px;">Signature of applicant / Relation</div>
                        <div style="clear:both;"></div>
                        <p style="font-size:10px; margin-top:10px;"><strong>N.B.: Fees once paid will not be returned.</strong></p>
                    </div>

                    <div class="office-use">
                        <div class="office-title">FOR OFFICE USE ONLY</div>
                        <div>Order: ____________________ &nbsp;&nbsp; Remarks: ___________________________________</div>
                        <div style="margin-top:10px;">
                            <span class="checkbox-item">&#9633; Document complete</span>
                            <span class="checkbox-item">&#9633; Document incomplete</span>
                            <span class="checkbox-item">&#9633; Admission allowed</span>
                            <span class="checkbox-item">&#9633; Not allowed</span>
                            <span class="checkbox-item">&#9633; Provisional allowed</span>
                        </div>
                    </div>
                </div>
            </body>
        </html>
    `);
            targetDoc.close();
        }

        async function downloadAdmissionPdf(data, printableAppId) {
            await ensureJsPdf();
            await ensureHtml2Canvas();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            // Render the same receipt HTML into an offscreen iframe, rasterize with html2canvas,
            // then paginate into the PDF. This is more predictable than `doc.html(...)`.
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.left = '-10000px';
            iframe.style.top = '0';
            iframe.style.width = '794px';   // ~A4 at 96dpi
            iframe.style.height = '1123px'; // ~A4 at 96dpi
            iframe.style.border = '0';
            iframe.style.opacity = '0';
            iframe.style.pointerEvents = 'none';
            document.body.appendChild(iframe);

            const receiptDoc = iframe.contentWindow.document;
            writeReceipt(receiptDoc, data, printableAppId);

            // Wait for images to load (prevents blank/partial renders).
            const imgs = Array.from(receiptDoc.images || []);
            await Promise.allSettled(imgs.map((img) => {
                if (img.complete) return Promise.resolve();
                return new Promise((resolve) => {
                    img.onload = () => resolve();
                    img.onerror = () => resolve();
                });
            }));

            // Let layout settle.
            await new Promise((r) => setTimeout(r, 50));

            const canvas = await window.html2canvas(receiptDoc.body, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                windowWidth: 794
            });

            iframe.remove();

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            const imgWidth = pageWidth - margin * 2;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let offset = 0;
            const pageContentHeight = pageHeight - margin * 2;
            while (offset < imgHeight) {
                doc.addImage(imgData, 'JPEG', margin, margin - offset, imgWidth, imgHeight);
                offset += pageContentHeight;
                if (offset < imgHeight) doc.addPage();
            }

            doc.save(`admission-${printableAppId || Date.now()}.pdf`);
        }

        function printConfirmation(data, printableAppId) {
            const printWindow = window.open('', '_blank');
            const iframe = !printWindow ? document.createElement('iframe') : null;

            if (iframe) {
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                document.body.appendChild(iframe);
            }

            const targetDoc = printWindow ? printWindow.document : iframe.contentWindow.document;
            writeReceipt(targetDoc, data, printableAppId);
            setTimeout(() => {
                if (printWindow) {
                    printWindow.focus();
                    printWindow.print();
                } else if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                    setTimeout(() => iframe.remove(), 1000);
                }
            }, 700);
        }

        function printFromAdmin() {
            printConfirmation(studentData, appNo);
        }

        async function downloadFromAdmin() {
            await downloadAdmissionPdf(studentData, appNo);
        }
    </script>

    <style>
        .bg-navy {
            background-color: #001f3f !important;
        }

        .btn-navy {
            background-color: #001f3f;
            color: white;
        }

        .text-navy {
            color: #001f3f;
        }

        .text-orange {
            color: #f37021;
        }
    </style>
